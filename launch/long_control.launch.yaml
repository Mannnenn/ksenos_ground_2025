launch:
  - group:
      - push-ros-namespace:
          namespace: "controller"

      - group:
          - push-ros-namespace:
              namespace: "long"

          - group:
              - push-ros-namespace:
                  namespace: "calc"

              - node:
                  pkg: ksenos_ground
                  exec: calc_average_altitude_velocity
                  name: calc_average_altitude_velocity_node
                  output: screen
                  remap:
                    - from: "/average/altitude_imu"
                      to: "/controller/long/calc/average_altitude_imu"
                    - from: "/average/flow_rate"
                      to: "/controller/long/calc/average_flow_rate"
                    - from: "/sensor/altitude_imu"
                      to: "/sensor/altitude/altitude_imu"
                    - from: "/sensor/altitude_lidar"
                      to: "/sensor/altitude/altitude_lidar"
                    - from: "/sbus_data"
                      to: "/sbus/manual/sbus_data"

              - node:
                  pkg: ksenos_ground
                  exec: mode_target_altitude_selector
                  name: mode_target_altitude_selector_node
                  output: screen
                  remap:
                    - from: "sbus_data"
                      to: "/sbus/manual/sbus_data"
                    - from: "average_altitude"
                      to: "/controller/long/calc/average_altitude_imu"
                    - from: "altitude_dynamic"
                      to: "/controller/long/calc/dynamic_altitude"
                    - from: "altitude_target"
                      to: "/controller/long/calc/target_altitude"

              - node:
                  pkg: ksenos_ground
                  exec: calc_energy
                  name: calc_energy_reference
                  param:
                    - name: mass
                      value: 0.23
                    - name: gravity
                      value: 9.81
                    - name: velocity_topic
                      value: "/controller/long/calc/average_flow_rate"
                    - name: altitude_topic
                      value: "/controller/long/calc/target_altitude"
                    - name: energy_topic
                      value: "/controller/long/reference_energy"

              - node:
                  pkg: ksenos_ground
                  exec: calc_energy
                  name: calc_energy_current
                  param:
                    - name: mass
                      value: 0.23
                    - name: gravity
                      value: 9.81
                    - name: velocity_topic
                      value: "/sensor/flow_rate"
                    - name: altitude_topic
                      # value: "/airplane/altitude_lidar"
                      value: "/sensor/altitude/altitude_imu"
                    - name: energy_topic
                      value: "/controller/long/current_energy"

          - group:
              - push-ros-namespace:
                  namespace: "control"

              - node:
                  pkg: ksenos_ground
                  exec: control_throttle
                  name: throttle_control_node
                  param:
                    - name: "kp"
                      value: 0.005
                    - name: "ki"
                      value: 0.0
                    - name: "max_throttle"
                      value: 0.7
                    - name: "min_throttle"
                      value: 0.0
                    - name: "steady_throttle"
                      value: 0.45
                      # value: 0.2
                    - name: "max_integral"
                      value: 0.5
                  remap:
                    - from: "/throttle_input"
                      to: "/controller/long/throttle_input"
                    - from: "/airplane/reference_energy"
                      to: "/controller/long/reference_energy"
                    - from: "/airplane/current_energy"
                      to: "/controller/long/current_energy"

              - node:
                  pkg: ksenos_ground
                  exec: control_elevator
                  name: elevator_control_node
                  param:
                    - name: "k_energy_gain"
                      value: 0.065
                    - name: "kd_pitch_angle"
                      value: -0.6
                    - name: "kd_pitch_rate"
                      value: 0.5
                    - name: "max_elevator"
                      value: 0.3
                    - name: "min_elevator"
                      value: -0.3
                    - name: "balanced_flight_pitch"
                      value: 0.0
                    # - name: "k_energy_gain"
                    #   value: 0.075
                    # - name: "kd_pitch_angle"
                    #   value: -0.6
                    # - name: "kd_pitch_rate"
                    #   value: 0.5
                    # - name: "max_elevator"
                    #   value: 0.3
                    # - name: "min_elevator"
                    #   value: -0.3
                    # - name: "balanced_flight_pitch"
                    #   value: 0.0
                  remap:
                    - from: "/elevator_input"
                      to: "/controller/long/elevator_input"
                    - from: "/airplane/reference_energy"
                      to: "/controller/long/reference_energy"
                    - from: "/airplane/current_energy"
                      to: "/controller/long/current_energy"
                    - from: "/rpy"
                      to: "/sensor/orientation/euler_angles"

      - node:
          pkg: ksenos_ground
          exec: unity_control_input
          name: unity_control_input_node
          remap:
            - from: "/throttle_input"
              to: "/controller/long/throttle_input"
            - from: "/elevator_input"
              to: "/controller/long/elevator_input"
            - from: "/aileron_input"
              to: "/controller/lat/aileron_input"
            - from: "/rudder_input"
              to: "/controller/lat/rudder_input"
